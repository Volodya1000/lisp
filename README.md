# Архитектура компилятора

Компилятор представляет собой транслятор AST → WAT, реализующий паттерн Visitor. Процесс трансляции разделен на две фазы: предварительное сканирование для регистрации глобальных определений и генерация инструкций.

Архитектура построена на строгом разделении ответственности: логика обхода узлов AST и генерации кода сосредоточена в классе `WasmCompiler`, тогда как все изменяемое состояние вынесено в класс `CompilerContext`. Именно `Context` управляет таблицами символов (`Environment`), списками глобальных переменных и реестром типов, что позволяет поддерживать чистоту процесса рекурсивного спуска. Результатом работы является единый модуль WebAssembly, включающий таблицу функций, конфигурацию памяти, импорты хост-системы и скомпилированный байт-код.

### Управление памятью

Модель памяти построена на линейной памяти WebAssembly с использованием стратегии **bump-pointer allocation**. Глобальная переменная `$heap_ptr` хранит адрес начала свободной области; выделение памяти происходит путем инкремента этого указателя. Освобождение памяти (Garbage Collection) в текущей реализации не предусмотрено.

Все данные в рантайме оперируются как 64-битные числа (`f64`), включая указатели. Структуры данных в куче имеют следующую организацию:
*   **Cons-ячейка:** Занимает 16 байт (два слота `f64` для `car` и `cdr`).
*   **Строка:** Хранится как непрерывный блок памяти. Первые 4 байта содержат длину строки (тип `i32`), а сразу за ними следуют байты символов в кодировке UTF-8. Это позволяет корректно определять границы данных без использования нуль-терминатора.
*   **Фрейм окружения:** Блок динамического размера, выравненный по границе 8 байт.

### Лямбда-выражения и замыкания

Поддержка лямбда-функций реализована через технику **Environment Passing**. Каждая лямбда компилируется в отдельную процедуру WebAssembly, принимающую скрытый первый аргумент `$env` — указатель на захваченный контекст.

В памяти замыкание представляется как cons-ячейка:
*   `car`: индекс функции в таблице косвенных вызовов (Table).
*   `cdr`: указатель на родительское окружение.

Вызовы производятся через инструкцию `call_indirect`. Рантайм извлекает индекс и среду из замыкания, передавая их целевой процедуре. Поскольку WebAssembly требует строгого соответствия типов, компилятор динамически отслеживает сигнатуры вызовов и генерирует соответствующие дефиниции типов (`type`) в заголовке модуля.

### Компоненты системы

**WasmCompiler**
Центральный класс-посетитель. Управляет обходом узлов AST, определяет структуру итогового модуля (порядок секций) и транслирует языковые конструкции (`defun`, `if`, `setq`) в инструкции WAT.

**CompilerContext**
Инкапсулирует изменяемое состояние компиляции: таблицы символов, списки глобальных переменных и реестр индексов для таблицы косвенных вызовов (`table_entries`). Также отвечает за генерацию уникальных имен для анонимных лямбд и отслеживание глубины стека.

**FramePolicy**
Отвечает за низкоуровневую арифметику указателей внутри стекового кадра в куче. Рассчитывает смещения (оффсеты) для доступа к локальным переменным и родительскому окружению, скрывая детали выравнивания памяти от основной логики.

**WasmStdLib**
Статическая библиотека времени исполнения (Runtime System). Содержит реализации примитивов работы со списками (`cons`, `car`, `cdr`), строковые операции, функции сравнения и настройки экспорта памяти. Обеспечивает минимально необходимое окружение для запуска скомпилированного кода.

**PrimitiveHandler**
Транслятор встроенных операций (математика, логика, ввод-вывод). Преобразует высокоуровневые примитивы либо в нативные опкоды WebAssembly, либо в вызовы функций стандартной библиотеки.

**TypeRegistry**
Менеджер системы типов. Отслеживает арность (количество аргументов) всех вызываемых функций и формирует корректные сигнатуры для секции `type` в WASM-модуле, что необходимо для валидации инструкций `call_indirect`.

**WatBuilder**
Инструмент для процедурной генерации S-выражений. Упрощает формирование корректного текста WAT, автоматически управляя вложенностью блоков и скобочной структурой.