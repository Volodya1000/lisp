# Архитектура и устройство компилятора

Компилятор представляет собой транслятор AST → WAT, реализующий паттерн Visitor. Процесс трансляции разделен на две фазы: предварительное сканирование для регистрации глобальных определений и генерация инструкций.

Архитектура построена на строгом разделении ответственности: логика обхода узлов AST и генерации кода сосредоточена в классе `WasmCompiler`, тогда как все изменяемое состояние вынесено в класс `CompilerContext`. Именно `Context` управляет таблицами символов (`Environment`), списками глобальных переменных и реестром типов, что позволяет поддерживать чистоту процесса рекурсивного спуска. Результатом работы является единый модуль WebAssembly, включающий таблицу функций, конфигурацию памяти, импорты хост-системы и скомпилированный байт-код.

### Управление памятью и представление данных

Для упрощения системы типов все значения в скомпилированном модуле — числа, логические значения и указатели памяти — унифицированы и передаются как числа с плавающей точкой (`f64`). При адресации памяти производится явное приведение типов (`f64` ↔ `i32`).

Модель памяти построена на стратегии последовательного выделения. Глобальная переменная `$heap_ptr` хранит адрес начала свободной области. Выделение памяти происходит максимально просто: текущее значение указателя возвращается как адрес нового объекта, а сам указатель увеличивается на размер этого объекта. Освобождение памяти в текущей реализации не предусмотрено.

Структуры данных в куче имеют следующую организацию:
*   **Cons-ячейка:** Занимает 16 байт (два слота `f64` для `car` и `cdr`).
*   **Строка:** Хранится как непрерывный блок памяти. Первые 4 байта содержат длину строки (тип `i32`), а сразу за ними следуют байты символов в кодировке UTF-8.
*   **Фрейм окружения:** Блок памяти, содержащий значения локальных переменных функции. Также хранит ссылку на окружение родительской функции.

### Лямбда-выражения и замыкания

Поддержка лямбда-функций реализована через передачу окружения. Каждая лямбда компилируется в отдельную процедуру WebAssembly, принимающую скрытый первый аргумент `$env` — указатель на захваченный контекст.

**Доступ к переменным**
Доступ к переменным осуществляется статически. Локальные переменные берутся по фиксированному смещению в текущем фрейме. Если переменная находится во внешней функции (замыкание), компилятор генерирует код, который проходит по цепочке родительских окружений**. Инструкции последовательно загружают ссылки на предыдущие фреймы (от текущего к родителю, от родителя к дедушке), пока не будет достигнута нужная область видимости.

В памяти замыкание представляется как cons-ячейка:
*   `car`: индекс функции в таблице косвенных вызовов (Table).
*   `cdr`: указатель на текущее окружение.

Вызовы производятся через инструкцию `call_indirect`. Рантайм извлекает индекс и среду из замыкания, передавая их целевой процедуре. Поскольку WebAssembly требует строгого соответствия типов, компилятор динамически отслеживает сигнатуры вызовов и генерирует необходимые определения типов (`type`) в заголовке модуля.

### Компоненты системы

**WasmCompiler**
Центральный класс-посетитель. Управляет обходом узлов AST, определяет структуру итогового модуля (порядок секций) и транслирует языковые конструкции (`defun`, `if`, `setq`) в инструкции WAT.

**CompilerContext**
Инкапсулирует изменяемое состояние компиляции: таблицы символов, списки глобальных переменных и реестр индексов для таблицы косвенных вызовов (`table_entries`). Отвечает за генерацию уникальных имен для анонимных лямбд и отслеживание глубины стека.

**FramePolicy**
Отвечает за низкоуровневую арифметику указателей внутри стекового кадра в куче. Рассчитывает смещения (оффсеты) в байтах для доступа к локальным переменным и ссылке на родительское окружение, скрывая детали выравнивания памяти от основной логики.

**WasmStdLib**
Статическая библиотека времени исполнения (Runtime System). Содержит реализации примитивов работы со списками (`cons`, `car`, `cdr`), строковые операции, функции сравнения и настройки экспорта памяти. Обеспечивает минимально необходимое окружение для запуска скомпилированного кода.

**PrimitiveHandler**
Транслятор встроенных операций (математика, логика, ввод-вывод). Преобразует высокоуровневые примитивы либо в нативные опкоды WebAssembly, либо в вызовы функций стандартной библиотеки.

**TypeRegistry**
Менеджер системы типов. Отслеживает количество аргументов всех вызываемых функций и формирует корректные сигнатуры для секции `type` в WASM-модуле. Это необходимо для валидации инструкций `call_indirect` виртуальной машиной.

**WatBuilder**
Инструмент для генерации S-выражений. Упрощает формирование корректного текста WAT, автоматически управляя вложенностью блоков (`block`, `loop`, `if`) и гарантируя правильную расстановку скобок в выходном файле.
